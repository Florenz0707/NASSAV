#!/usr/bin/env python3
"""
ç¿»è¯‘ç»“æœæ¸…ç†åŠŸèƒ½æµ‹è¯•

åŠŸèƒ½ï¼š
1. æµ‹è¯•ç¿»è¯‘ç»“æœä¸­å¤šä½™è¯´æ˜æ–‡å­—çš„æ¸…ç†
2. éªŒè¯å„ç§æ ¼å¼çš„æ³¨é‡Šå’Œè¯´æ˜æ–‡å­—èƒ½è¢«æ­£ç¡®ç§»é™¤
3. ç¡®ä¿æ ‡é¢˜å†…å®¹è¢«å®Œæ•´ä¿ç•™

æµ‹è¯•ç”¨ä¾‹ï¼š
- åŒ…å«"ï¼ˆæ³¨ï¼š...ï¼‰"æ ¼å¼æ³¨é‡Šçš„æ ‡é¢˜
- åŒ…å«"ç¿»è¯‘è¯´æ˜ï¼š"åŠç¼–å·åˆ—è¡¨çš„æ ‡é¢˜
- åŒ…å«"æ ‡é¢˜ï¼š"å‰ç¼€çš„æ ‡é¢˜

è¿è¡Œæ–¹å¼ï¼š
    uv run tests/test_translation_cleaning.py

é¢„æœŸè¾“å‡ºï¼š
    æ˜¾ç¤ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥ã€æœŸæœ›è¾“å‡ºã€å®é™…è¾“å‡ºå’Œé€šè¿‡çŠ¶æ€

ç¤ºä¾‹ï¼š
    $ uv run tests/test_translation_cleaning.py
    ================================================================================
    ç¿»è¯‘ç»“æœæ¸…ç†æµ‹è¯•
    ================================================================================

    æµ‹è¯•ç”¨ä¾‹: PRED-505
    --------------------------------------------------------------------------------
    è¾“å…¥:
    æ ‡é¢˜ï¼šå› ä¸ºè¢«æ±‚å©šçš„é€¢èŠ±æ˜¯ä¸ª"ä¼ªå……çœŸ"çš„ä¼ªå–„è€…...

    æœŸæœ›è¾“å‡º:
    å› ä¸ºè¢«æ±‚å©šçš„é€¢èŠ±æ˜¯ä¸ª"ä¼ªå……çœŸ"çš„ä¼ªå–„è€…...

    å®é™…è¾“å‡º:
    å› ä¸ºè¢«æ±‚å©šçš„é€¢èŠ±æ˜¯ä¸ª"ä¼ªå……çœŸ"çš„ä¼ªå–„è€…...

    âœ… é€šè¿‡
    ================================================================================
"""

import sys
from pathlib import Path

# è®¾ç½®è·¯å¾„
BASE_DIR = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(BASE_DIR))

# æµ‹è¯•ç”¨ä¾‹
test_cases = [
    {
        "name": "PRED-505",
        "input": """æ ‡é¢˜ï¼šå› ä¸ºè¢«æ±‚å©šçš„é€¢èŠ±æ˜¯ä¸ª"ä¼ªå……çœŸ"çš„ä¼ªå–„è€…ï¼ŒçœŸè®©äººæ¼ç«ï¼Œæ‰€ä»¥åœ¨å©šç¤¼å‰æˆ‘æƒ³å’Œå¥¹å‘ç”Ÿå…³ç³»ï¼Œè®©å¥¹å¤šæ¬¡ä¸ºæˆ‘æ€€å­•ã€‚ å±±å²¸é€¢èŠ±

ï¼ˆæ³¨ï¼šç¿»è¯‘ä¸­ä¿ç•™äº†"ä¼ªå……çœŸ"çš„æ¦‚å¿µï¼Œå› ä¸ºè¿™æ˜¯æ—¥æœ¬AVæ ‡é¢˜ä¸­å¸¸è§çš„è¡¨è¾¾ï¼Œç”¨æ¥å½¢å®¹é‚£äº›è¡¨é¢ä¸Šä¼ªå–„ä½†å®é™…ä¸Šè¡Œä¸ºä¸ç«¯çš„å¥³æ€§ã€‚åŒæ—¶ï¼Œä½¿ç”¨äº†"å‘ç”Ÿå…³ç³»"å’Œ"æ€€å­•"ç­‰ç›´ç™½çš„è¡¨è¾¾ï¼Œä»¥ç¬¦åˆæ—¥æœ¬AVæ ‡é¢˜çš„é£æ ¼ã€‚ï¼‰""",
        "expected": 'å› ä¸ºè¢«æ±‚å©šçš„é€¢èŠ±æ˜¯ä¸ª"ä¼ªå……çœŸ"çš„ä¼ªå–„è€…ï¼ŒçœŸè®©äººæ¼ç«ï¼Œæ‰€ä»¥åœ¨å©šç¤¼å‰æˆ‘æƒ³å’Œå¥¹å‘ç”Ÿå…³ç³»ï¼Œè®©å¥¹å¤šæ¬¡ä¸ºæˆ‘æ€€å­•ã€‚ å±±å²¸é€¢èŠ±',
    },
    {
        "name": "ABF-139",
        "input": """æ ‡é¢˜ï¼šåœ¨ä¸€æ— æ‰€æœ‰çš„ä¹¡æ‘é‡Œï¼Œå’Œé’æ¢…ç«¹é©¬ä¸€èµ·æ¯å¤©è¿›è¡Œæ±—æµæµƒèƒŒçš„æ¿€çƒˆæ€§çˆ±ã€‚æ¡ˆä¾‹13ï¼šæ³·æœ¬é›«è‘‰ã€é™„å¸¦MGSä¸“å±çš„é¢å¤–æ˜ åƒï¼Œæ—¶é•¿30åˆ†é’Ÿã€‘""",
        "expected": "åœ¨ä¸€æ— æ‰€æœ‰çš„ä¹¡æ‘é‡Œï¼Œå’Œé’æ¢…ç«¹é©¬ä¸€èµ·æ¯å¤©è¿›è¡Œæ±—æµæµƒèƒŒçš„æ¿€çƒˆæ€§çˆ±ã€‚æ¡ˆä¾‹13ï¼šæ³·æœ¬é›«è‘‰ã€é™„å¸¦MGSä¸“å±çš„é¢å¤–æ˜ åƒï¼Œæ—¶é•¿30åˆ†é’Ÿã€‘",
    },
    {
        "name": "MIDV-023",
        "input": """Angel Kissï¼šãƒ“ã‚¢ãƒ³ãŸã¡ã®æ„›æƒ…ç‰©èª8

ç¿»è¯‘è¯´æ˜ï¼š
1. ä¿ç•™äº†æ—¥è¯­æ ‡é¢˜ä¸­çš„ä¸“æœ‰åè¯"ãƒ“ã‚¢ãƒ³ï¼ˆBianï¼‰"ï¼Œå¹¶å°†å…¶ç¿»è¯‘ä¸º"Bianï¼ˆäººåï¼‰"ï¼Œå¹¶å°†å…¶æ”¾åœ¨æ ‡é¢˜æœ«å°¾ã€‚
2. å°†æ ‡é¢˜ç¿»è¯‘ä¸º"Angel Kissï¼šBianä»¬çš„çˆ±æƒ…æ•…äº‹8"ï¼Œä¿ç•™äº†åŸæ ‡é¢˜ä¸­çš„"Angel Kiss"ï¼ˆå¤©ä½¿ä¹‹å»ï¼‰è¿™ä¸€æµªæ¼«å…ƒç´ ï¼ŒåŒæ—¶ç”¨"çˆ±æƒ…æ•…äº‹"æ¥ä¼ è¾¾æ ‡é¢˜ä¸­çš„æµªæ¼«æƒ…æ„Ÿã€‚
3. ä¿ç•™äº†åŸæ ‡é¢˜ä¸­çš„"8"ï¼ˆç¬¬8éƒ¨ï¼‰ï¼Œè¡¨ç¤ºè¿™æ˜¯è¯¥ç³»åˆ—ä¸­çš„ç¬¬8éƒ¨ä½œå“ã€‚
4. é‡‡ç”¨äº†ä¸­æ–‡å¸¸è§çš„AVä½œå“æ ‡é¢˜è¡¨è¾¾æ–¹å¼ï¼Œå¦‚"å¤©ä½¿ä¹‹å»"å’Œ"çˆ±æƒ…æ•…äº‹"ï¼ŒåŒæ—¶ä¿æŒäº†æ ‡é¢˜çš„ç®€æ´å’Œå¸å¼•åŠ›ã€‚
5. ä¿æŒäº†åŸæ ‡é¢˜çš„ä¸­æ–‡è¡¨è¾¾é£æ ¼ï¼ŒåŒæ—¶ç¡®ä¿ä¸­æ–‡æ ‡é¢˜çš„æµç•…æ€§å’Œå¯è¯»æ€§ã€‚""",
        "expected": "Angel Kissï¼šãƒ“ã‚¢ãƒ³ãŸã¡ã®æ„›æƒ…ç‰©èª8",
    },
    {
        "name": "å¸¦æ³¨é‡Šçš„ç®€å•æ ‡é¢˜",
        "input": """åœ¨æ— æ‰€äº‹äº‹çš„ä¹¡ä¸‹ä¸é’æ¢…ç«¹é©¬çš„æµ“å¯†æ€§çˆ±ç”Ÿæ´» (æ³¨: è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ³¨é‡Š)""",
        "expected": "åœ¨æ— æ‰€äº‹äº‹çš„ä¹¡ä¸‹ä¸é’æ¢…ç«¹é©¬çš„æµ“å¯†æ€§çˆ±ç”Ÿæ´»",
    },
    {
        "name": "å¸¦ä¸­æ–‡æ‹¬å·æ³¨é‡Š",
        "input": """ç¾å°‘å¥³çš„ç§˜å¯†æ‹æƒ…ï¼ˆæ³¨ï¼šä¿ç•™äº†äººåå’Œåœ°åï¼‰- å±±ç”°èŠ±å­""",
        "expected": "ç¾å°‘å¥³çš„ç§˜å¯†æ‹æƒ…- å±±ç”°èŠ±å­",
    },
]


def test_cleaning():
    """æµ‹è¯•æ¸…ç†å‡½æ•°"""
    from nassav.translator.OllamaTranslator import OllamaTranslator

    # åˆ›å»ºç¿»è¯‘å™¨å®ä¾‹ï¼ˆä»…ç”¨äºæµ‹è¯•æ¸…ç†åŠŸèƒ½ï¼‰
    translator = OllamaTranslator()

    print("=" * 80)
    print("ç¿»è¯‘ç»“æœæ¸…ç†æµ‹è¯•")
    print("=" * 80)

    passed = 0
    failed = 0

    for test in test_cases:
        print(f"\næµ‹è¯•ç”¨ä¾‹: {test['name']}")
        print("-" * 80)
        print("è¾“å…¥:")
        print(test["input"])
        print("\næœŸæœ›è¾“å‡º:")
        print(test["expected"])

        # æ‰§è¡Œæ¸…ç†
        cleaned = translator._clean_translation(test["input"])

        print("\nå®é™…è¾“å‡º:")
        print(cleaned)

        # éªŒè¯
        if cleaned.strip() == test["expected"].strip():
            print("\nâœ… é€šè¿‡")
            passed += 1
        else:
            print("\nâŒ å¤±è´¥")
            print(f"å·®å¼‚:")
            print(f"  æœŸæœ›é•¿åº¦: {len(test['expected'].strip())}")
            print(f"  å®é™…é•¿åº¦: {len(cleaned.strip())}")
            # æ˜¾ç¤ºå­—ç¬¦å·®å¼‚
            expected_lines = test["expected"].strip().split("\n")
            actual_lines = cleaned.strip().split("\n")
            if len(expected_lines) != len(actual_lines):
                print(f"  è¡Œæ•°ä¸åŒ: æœŸæœ› {len(expected_lines)} è¡Œ, å®é™… {len(actual_lines)} è¡Œ")
            failed += 1

        print("=" * 80)

    print(f"\nğŸ“Š æµ‹è¯•å®Œæˆ: {passed} é€šè¿‡, {failed} å¤±è´¥")
    return failed == 0


if __name__ == "__main__":
    import os

    import django

    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "django_project.settings")
    django.setup()

    success = test_cleaning()
    sys.exit(0 if success else 1)
